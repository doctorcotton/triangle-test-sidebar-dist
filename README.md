# 三点测试助手

一个基于飞书多维表格的边栏插件，用于三点测试（Triangle Test）的测试方案生成、数据统计和报告生成。

## 项目概述

本项目是一个飞书多维表格的边栏插件，实现了三点测试的完整工作流：

- **PDF 生成模式**：从飞书表格读取测试数据，自动生成包含测试方案和二维码的 PDF 文档
- **结果统计模式**：统计测试结果，按 GB/T 12311-2012 标准进行显著性判定，生成 Markdown 报告
- **字段配置模式**：可视化配置所有表、视图、字段的 ID，支持配置持久化

## 技术架构

### 技术栈

- **前端框架**：React 18 + TypeScript
- **构建工具**：Vite 4
- **PDF 生成**：pdf-lib + @pdf-lib/fontkit
- **二维码生成**：qrcode
- **飞书 SDK**：@lark-base-open/js-sdk
- **日期处理**：dayjs
- **字体支持**：@fontsource/noto-sans-sc（中文字体）

### 项目结构

```
src/
├── components/          # React 组件
│   ├── PdfMode.tsx     # PDF 生成模式界面
│   ├── StatMode.tsx    # 结果统计模式界面
│   ├── ConfigMode.tsx  # 字段配置模式界面
│   └── SearchableSelect.tsx  # 可搜索下拉选择组件
├── hooks/              # 自定义 Hooks
│   ├── useConfig.ts   # 配置管理 Hook
│   ├── usePdfMode.ts  # PDF 模式逻辑 Hook
│   └── useStatMode.ts # 统计模式逻辑 Hook
├── services/          # 业务逻辑服务
│   ├── pdfBuilder.ts  # PDF 生成服务
│   └── statReport.ts  # 统计报告生成服务
├── utils/             # 工具函数
│   ├── dataParsing.ts # 数据解析工具
│   ├── fontUtils.ts   # 字体加载工具
│   └── statistics.ts  # 统计计算工具
├── configEditor.ts    # 配置表管理
├── constants.ts       # 常量定义
├── types.ts          # TypeScript 类型定义
└── fieldNameMapping.ts # 字段名映射

```

## 核心功能

### 1. PDF 生成模式

#### 功能特性

- **记录选择**：支持搜索、分页浏览测试记录
- **数据预览**：实时预览测试方案数据（组别、排布、标注、正确答案）
- **PDF 生成**：
  - 第一页：测试摘要页（测试信息 + 数据表格）
  - 第二页：二维码页（6 组二维码，横版布局）
  - 第三页：竖版二维码页（6 列 × 8 行，列对应组序 A1-A3、B1-B3）
- **字体支持**：自动检测中文内容，嵌入中文字体（Arial Unicode 或 Noto Sans SC）
- **附件上传**：支持将生成的 PDF 自动上传到飞书附件字段

#### PDF 布局说明

- **摘要页**：竖版 A4（595×842pt），包含测试名称、测试样品、测试类型和完整的组别数据表格
- **二维码页**：横版布局，6 组二维码并排显示
- **竖版二维码页**：竖版 A4，6 列 × 8 行布局，每列对应一个组别（第一列 A1，第二列 A2...），每列重复 8 次，便于裁剪分发

### 2. 结果统计模式

#### 功能特性

- **数据筛选**：按测试名称筛选统计记录，支持关键字搜索
- **分组统计**：按组别（A1-A3、B1-B3）统计人数、正确数、正确率
- **显著性判定**：
  - 支持两种测试类型：**备选测试**（相似检验，α=0.05）和**工厂样品**（差异检验，α=0.10）
  - 自动计算显著性阈值，按 GB/T 12311-2012 标准判定
  - 样本量范围：备选测试 42-54 份，工厂样品 36-54 份
- **报告生成**：生成符合规范的 Markdown 报告，包含：
  - 测试批次信息
  - 测试方法和原理
  - 测试结果和结论
  - 各组统计表格
  - 正确记录明细
- **报告写入**：支持将报告写入飞书表格字段

#### 判定规则

- **备选测试**（相似检验）：
  - 样本量 ≤ 42：最大允许正确数 16（显著阈值 17）
  - 样本量 43-54：按表值计算最大允许正确数
  - 正确数 < 阈值：通过（无显著差异）
  - 正确数 ≥ 阈值：未通过（存在显著差异）

- **工厂样品**（差异检验）：
  - 样本量 ≤ 36：固定阈值 18
  - 样本量 37-54：按表值计算阈值
  - 正确数 < 阈值：未通过（存在显著差异）
  - 正确数 ≥ 阈值：通过（无显著差异）

### 3. 字段配置模式

#### 功能特性

- **配置分类**：配置项按类别分组（六组字段、PDF模式、统计模式、报告写入）
- **智能选择**：
  - 表/视图/字段下拉选择，支持搜索过滤
  - 字段选择自动过滤类型（如附件字段仅显示附件类型）
  - 组别字段自动匹配对应组别（A1-A3、B1-B3）
- **配置持久化**：配置存储在「三点测试助手配置表」，自动创建和管理
- **默认值恢复**：支持一键恢复默认配置

#### 配置项说明

配置项分为四类：

1. **六组字段**：A1-A3、B1-B3 每组三个字段（选项字段、正确答案字段、二维码字段）
2. **PDF模式**：PDF 表/视图 ID、测试类型字段、测试样品名称字段、附件字段
3. **统计模式**：统计表/视图 ID、关联字段、组别字段、答案字段、评价字段等
4. **报告写入**：报告表 ID、报告字段、测试结论字段

## 开发指南

### 环境要求

- Node.js >= 16
- npm 或 yarn

### 安装依赖

```bash
npm install
```

### 开发模式

```bash
npm run dev
```

开发服务器默认运行在 `http://localhost:5173`，支持局域网访问。

### 构建

```bash
npm run build
```

构建产物输出到 `dist/` 目录。

### 预览构建结果

```bash
npm run preview
```

## 配置说明

### 默认配置

项目在 `src/configEditor.ts` 中定义了默认的表/视图/字段 ID，首次使用时会在飞书多维表格中自动创建「三点测试助手配置表」并写入默认配置。

### 配置表结构

配置表包含以下字段：

- **配置项**（主键）：配置项键名，如 `A1_optionFieldId`
- **类别**：配置项分类（六组字段、PDF模式、统计模式、报告写入）
- **值**：配置项的值（通常是表/视图/字段 ID）
- **说明**：配置项的描述

### 字段映射

项目使用 `src/fieldNameMapping.ts` 进行字段名的友好显示映射，便于在界面上显示可读的字段名。

## 使用说明

### 首次使用

1. 在飞书多维表格中打开边栏插件
2. 切换到「字段配置模式」
3. 根据实际的多维表格结构，配置所有表、视图、字段的 ID
4. 点击「保存到配置表」保存配置

### PDF 生成流程

1. 切换到「PDF 生成模式」
2. 从记录列表中选择一条测试记录
3. 点击「读取数据」加载测试方案数据
4. 检查数据预览是否正确
5. 点击「生成 PDF」，系统会：
   - 生成包含摘要页、二维码页、竖版二维码页的 PDF
   - 自动下载 PDF 文件
   - 如果配置了附件字段，会自动上传到对应记录

### 结果统计流程

1. 切换到「结果统计模式」
2. 选择测试名称（或使用搜索过滤）
3. 设置每组人数（用于样本量验证）
4. 点击「读取统计数据」
5. 查看数据概览和正确记录明细
6. 点击「生成 MD 报告」生成统计报告
7. （可选）点击「写入报告字段」将报告写入飞书表格

## 注意事项

### 中文字体

- 项目支持中文字体嵌入，字体文件应放在 `public/fonts/` 目录
- 如果字体加载失败，PDF 中的中文可能显示为空白或乱码
- 推荐使用 Arial Unicode 或 Noto Sans SC 字体

### 二维码生成

- 二维码数据来源于配置的「二维码字段」
- 如果字段值为空或无效，二维码会显示「缺少链接」
- 二维码使用中等错误纠正级别（M），支持一定程度的损坏容错

### 统计判定

- 统计判定严格按照 GB/T 12311-2012 标准
- 样本量不足时无法进行有效判定，系统会提示补足样本
- 判定结果仅供参考，实际应用需结合具体情况

### 配置管理

- 配置表会自动创建，无需手动创建
- 修改配置后需要点击「保存到配置表」才会生效
- 配置表支持多视图，但插件默认使用第一个可见视图

## 依赖说明

### 核心依赖

- `@lark-base-open/js-sdk`：飞书多维表格 SDK，用于数据读写
- `pdf-lib`：PDF 文档生成库
- `@pdf-lib/fontkit`：字体处理库，支持中文字体嵌入
- `qrcode`：二维码生成库
- `dayjs`：日期时间处理库

### 开发依赖

- `vite`：构建工具
- `@vitejs/plugin-react`：React 插件
- `typescript`：TypeScript 编译器

## 许可证

本项目为私有项目，未经授权不得使用或分发。

